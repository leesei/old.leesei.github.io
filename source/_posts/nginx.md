---
title: "Nginx"
date: 2014-12-11 17:57:51
categories:
  - web
tags:
  - nginx
  - notes
toc: true
---

[nginx news](http://nginx.org/)
[nginx - ArchWiki](https://wiki.archlinux.org/index.php/Nginx)

[fcambus/nginx-resources: A collection of resources covering Nginx, Nginx + Lua, OpenResty and Tengine](https://github.com/fcambus/nginx-resources)
[schenkd/nginx-ui: Nginx UI allows you to access and modify the nginx configurations files without cli.](https://github.com/schenkd/nginx-ui)

## References

[nginx documentation](http://nginx.org/en/docs/)
[Beginner’s Guide](http://nginx.org/en/docs/beginners_guide.html)
[Alphabetical index of directives](http://nginx.org/en/docs/dirindex.html)
[NGINX and NGINX Plus Admin Guide | NGINX](https://www.nginx.com/resources/admin-guide/)

[Nginx Community](http://wiki.nginx.org/Main)
[GettingStarted - Nginx Community](http://wiki.nginx.org/GettingStarted)
[Pitfalls - Nginx Community](http://wiki.nginx.org/Pitfalls)

[Nginx 开发从入门到精通 — Nginx 开发从入门到精通](http://tengine.taobao.org/book/index.html)
[agentzh\_新浪博客](http://blog.sina.com.cn/openresty)
[agentzh's Nginx Tutorials](http://openresty.org/download/agentzh-nginx-tutorials-en.html) [download](http://openresty.org/#eBooks) [source](https://github.com/openresty/nginx-tutorials)
[Nginx Guide - Envato Tuts+ Code Tutorials](https://code.tutsplus.com/series/nginx-guide--cms-792)
[nginx | 夢想家](https://datahunter.org/nginx)
[The Architecture of Open Source Applications (Volume 2): nginx](http://www.aosabook.org/en/nginx.html)

[agile6v/awesome-nginx: A curated list of awesome Nginx distributions、third modules、active developers and etc.](https://github.com/agile6v/awesome-nginx)

[Nginx Tutorials | DigitalOcean](https://www.digitalocean.com/community/tags/nginx?type=tutorials)

## Tips and Tricks

[Nginx Secure SSL Web Server @ Calomel.org](https://calomel.org/nginx.html)
[Tuning NGINX for Performance - NGINX](https://www.nginx.com/blog/tuning-nginx/)
[10 Tips to Improve Application Performance | NGINX](https://www.nginx.com/blog/10-tips-for-10x-application-performance/)
[Optimizing HTTPS on Nginx](https://bjornjohansen.no/optimizing-https-nginx)
[How To Create a Self-Signed SSL Certificate for Nginx in Ubuntu 16.04 | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-16-04)
[How To Set Up Nginx with HTTP/2 Support on Ubuntu 16.04 | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-with-http-2-support-on-ubuntu-16-04)
[DDos Mitigation - Using NGINX to Prevent DDoS Attacks | NGINX](https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus/)
[Tuning NGINX - via @codeship | via @codeship](https://blog.codeship.com/tuning-nginx/)

[NGINX Docs | All-Active HA for NGINX Plus on the Google Cloud Platform](https://docs.nginx.com/nginx/deployment-guides/gcp-high-availability-all-active/)
[NGINX Docs | Load Balancing Apache Tomcat Servers with NGINX Open Source and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/apache-tomcat-load-balancing-nginx-plus/)

[Public IP Address API with two lines of Nginx config](https://www.ecalamia.com/blog/show-ip-api-nginx/)

[Using NGINX to Serve .NET Core, Nodejs, or Static Contents - DZone Web Dev](https://dzone.com/articles/using-nginx-to-serve-net-core-nodejs-or-static-con)

## OpenResty

[OpenResty - Official Site](http://openresty.org/en/) Nginx + module bundles
[OpenResty Reference](https://openresty-reference.readthedocs.io/en/latest/)

[bungle/awesome-resty: A List of Quality OpenResty Libraries, and Resources.](https://github.com/bungle/awesome-resty)
[OpenResty - Using LuaRocks](https://openresty.org/en/using-luarocks.html)

[ficusio/openresty/](https://hub.docker.com/r/ficusio/openresty/)
[Load Balancing Search Traffic at Algolia with NGINX and OpenResty](https://www.infoq.com/news/2019/04/loadbalancing-nginx-algolia/)

[agentzh's presentations](http://agentzh.org/#Presentations)

[agentzh's Nginx Tutorials (version 2015.03.19)](https://openresty.org/download/agentzh-nginx-tutorials-en.html)
[OpenResty 最佳实践 - GitBook](https://www.gitbook.com/book/moonbingbing/openresty-best-practices/details)
[Programming OpenResty · GitBook](https://www.gitbook.com/book/openresty/programming-openresty/details)
[乱入 OpenResty 手册! — chaos2openResty 2.1.130619 documentation](http://chaos2.qiniudn.com/openresty/build/html/)
[An Introduction To OpenResty (nginx + lua) - Part 1](http://openmymind.net/An-Introduction-To-OpenResty-Nginx-Lua/)
[An Introduction To OpenResty - Part 2 - Concepts](http://openmymind.net/An-Introduction-To-OpenResty-Part-2/)
[An Introduction To OpenResty - Part 3](http://openmymind.net/An-Introduction-To-OpenResty-Part-3/)

[Lapis - A web framework for Lua or MoonScript powered by OpenResty](http://leafo.net/lapis/)

### Presentations

[Application of Lua in Nginx](http://agentzh.org/misc/slides/qcon-beijing-2015/)

[由 Lua 粘合的 Nginx 生态环境 -- agentzh tech-club.org 演讲听录 @ 2012-03-06 01:13 - Zoom.Quiet's PyBlosxom blogging](http://blog-zq-org.qiniucdn.com/pyblosxom/2012/03/) [slides](http://agentzh.org/misc/slides/ngx-openresty-ecosystem/#8)

[openresty/ngx_openresty: Turning Nginx into a Full-Fledged Scriptable Web Platform](https://github.com/openresty/ngx_openresty)
[openresty/lua-nginx-module - C](https://github.com/openresty/lua-nginx-module)
[openresty/lua-resty-core: New FFI-based API for lua-nginx-module](https://github.com/openresty/lua-resty-core)
[openresty/lua-resty-upload: Streaming reader and parser for http file uploading based on ngx_lua cosocket](https://github.com/openresty/lua-resty-upload)

[auth0/nginx-jwt: Lua script for Nginx that performs reverse proxy auth using JWT's](https://github.com/auth0/nginx-jwt)

[grimen/nginx-sandbox: Nginx/OpenResty sandbox/playground - for experiments with building Nginx apps using Lua.](https://github.com/grimen/nginx-sandbox)

## Nginx Unit

[Announcing NGINX Unit 1.0 | NGINX](https://www.nginx.com/blog/nginx-unit-1-0-released/)
[About — NGINX Unit](http://unit.nginx.org/)

[Introducing NGINX Unit - YouTube](https://www.youtube.com/watch?v=EU78CIR3CeU)
[Introducing NGINX Controller - YouTube](https://www.youtube.com/watch?v=RjatLgMZvh0)

## Tengine

[The Tengine Web Server](http://tengine.taobao.org/index.html) Taobao's fork
[在新版 Tengine 中开启 HTTP/2 协议支持 | 柳志超博客](https://liuzhichao.com/2016/tengine-http2.html#more)
[Difference between openresty and tengine · Issue #54 · openresty/openresty](https://github.com/openresty/openresty/issues/54)

## Amplify

[nginxinc/nginx-amplify-doc: Public documentation for Amplify](https://github.com/nginxinc/nginx-amplify-doc/)

## vs Apache

[NGINX vs. Apache: Our View of a Decade-Old Question](https://www.nginx.com/blog/nginx-vs-apache-our-view/)
[Nginx vs. Apache - Michael Lustfield](https://michael.lustfield.net/nginx/nginx-vs-apache)
[Apache vs Nginx: Practical Considerations | DigitalOcean](https://www.digitalocean.com/community/tutorials/apache-vs-nginx-practical-considerations)
[Apache vs Nginx](https://www.upguard.com/articles/apache-vs-nginx)

## Configuration

> https://github.com/h5bp/server-configs-nginx > https://github.com/Umkus/nginx-boilerplate > https://github.com/perusio/nginx_ensite

[Configuration - Nginx Community](http://wiki.nginx.org/Configuration)

[Core functionality](http://nginx.org/en/docs/ngx_core_module.html)
[Module ngx_http_core_module](http://nginx.org/en/docs/http/ngx_http_core_module.html)

[Serving Static Content | NGINX](https://www.nginx.com/resources/admin-guide/serving-static-content/)

[Nginx Configuration Primer](http://blog.martinfjordvald.com/2010/07/nginx-primer/)
[Nginx Primer 2: From Apache to Nginx](https://blog.martinfjordvald.com/2011/02/nginx-primer-2-from-apache-to-nginx/)
[Nginx Library](http://nginxlibrary.com/)
[Debugging Nginx Errors](https://blog.martinfjordvald.com/2013/06/debugging-nginx-errors/)
[Understanding the Nginx Configuration Inheritance Model](https://blog.martinfjordvald.com/2012/08/understanding-the-nginx-configuration-inheritance-model/)
[How to Configure nginx](https://www.linode.com/docs/web-servers/nginx/how-to-configure-nginx)
[Hardening node.js for production part 2: using nginx to avoid node.js load | Arg! Team Blog](http://blog.argteam.com/coding/hardening-node-js-for-production-part-2-using-nginx-to-avoid-node-js-load/)

[Understanding Nginx Server and Location Block Selection Algorithms | DigitalOcean](https://www.digitalocean.com/community/tutorials/understanding-nginx-server-and-location-block-selection-algorithms)
[How To Set Up Nginx Server Blocks (Virtual Hosts) on Ubuntu 16.04 | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-server-blocks-virtual-hosts-on-ubuntu-16-04)
[Understanding the Nginx Configuration File Structure and Configuration Contexts | DigitalOcean](https://www.digitalocean.com/community/tutorials/understanding-the-nginx-configuration-file-structure-and-configuration-contexts)
[How To Optimize Nginx Configuration | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-optimize-nginx-configuration)

Main config filer (`nginx.conf`) sits in the Nginx config folder (e.g. `/etc/nginx`).

> this config distro specific:
> There are `sites-available/` and `sites-enabled/`, default setting file includes `sites-enabled/*`.
> Server files are usually put in `sites-available/` and symlinked to `sites-enabled/`.

Options are called _directives_. They can live inside blocks (contexts) which define the scope they apply. Contexts are hierarchical: `main`, (`http`, `mail`, `stream`), `server`, `location`.

An array directive (e.g.: `fastcgi_param`) is basically any directive that can be used more than once in a single context. Each subsequent declaration (in the same scope) will append the new information to what Nginx knows from the previous declarations. Any declaration in sub-scope will clear the declarations in the parent scope.

### Access Control

[NGINX Docs | Restricting Access with HTTP Basic Authentication](https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/)
[Protecting Folders with Nginx » KBeezie](http://kbeezie.com/protecting-folders-with-nginx/)

[Dynamic Drive: .htaccess password generator](http://www.tools.dynamicdrive.com/password/)

### Snippets

[h5bp/server-configs-nginx: Nginx HTTP server boilerplate configs](https://github.com/h5bp/server-configs-nginx)
[timgws/handy-nginx-includes: 'best practice' nginx configuration includes.](https://github.com/timgws/handy-nginx-includes)
[lebinh/nginx-conf: A collection of useful Nginx configuration snippets](https://github.com/lebinh/nginx-conf) !important
[danielrichman/nginx-config-snippets: nginx config snippets: gzip, catchall, domain c14n, ssl, uwsgi, php, wordpress](https://github.com/danielrichman/nginx-config-snippets)

## Internals

[Inside NGINX - NGINX](https://www.nginx.com/resources/library/infographic-inside-nginx/)
[Inside NGINX: Designed for Performance & Scalability](https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/)
[Boosting NGINX Performance 9x with Thread Pools](https://www.nginx.com/blog/thread-pools-boost-performance-9x/)

[server-configs-nginx/how-nginx-works.md at master · h5bp/server-configs-nginx](https://github.com/h5bp/server-configs-nginx/blob/master/doc/how-nginx-works.md)
[How nginx processes a request](http://nginx.org/en/docs/http/request_processing.html)

[How we scaled nginx and saved the world 54 years every day](https://blog-cloudflare-com.cdn.ampproject.org/v/s/blog.cloudflare.com/how-we-scaled-nginx-and-saved-the-world-54-years-every-day/)

## nginScript

[Launching nginScript and Looking Ahead - NGINX](https://www.nginx.com/blog/launching-nginscript-and-looking-ahead/)
[nginScript - why create our own JavaScript implementation?](https://www.nginx.com/blog/nginscript-why-our-own-javascript-implementation/)
[nginScript - A New and Powerful Way to Configure NGINX - NGINX](https://www.nginx.com/blog/nginscript-new-powerful-way-configure-nginx/)
[nginScript Documentation | NGINX](https://www.nginx.com/resources/wiki/nginScript/)

## System service

### Debian/Ubuntu

> https://github.com/JasonGiedymin/nginx-init-ubuntu > https://github.com/hulihanapplications/nginx-init-debian

```sh
$ sudo service nginx
configtest    force-reload  reload        restart       start         status        stop
```

### systemd

```sh
sudo systemctl enable --now nginx.service
```

## Modules

[3rdPartyModules - Nginx Community](http://wiki.nginx.org/3rdPartyModules)
[Emiller's Guide to Nginx Module Development](http://www.evanmiller.org/nginx-modules-guide.html)

| Module        | Link                                                   |
| ------------- | ------------------------------------------------------ |
| Auth Digest   | https://github.com/samizdatco/nginx-http-auth-digest   |
| nginx-jwt     | https://github.com/auth0/nginx-jwt                     |
| Echo          | https://github.com/agentzh/echo-nginx-module           |
| Fancy Indexes | https://github.com/aperezdc/ngx-fancyindex             |
| Log If        | https://github.com/cfsego/ngx_log_if/                  |
| PageSpeeed    | http://ngxpagespeed.com/ngx_pagespeed_example/         |
| MP4 streaming | http://nginx.org/en/docs/http/ngx_http_mp4_module.html |

---

# Use Cases

## Static file serving

```nginx
user http;

server {
    listen   80;
    server_name  domain.com www.domain.com;
    access_log   /var/log/nginx/static_server.log combined;
    root   /home/www;
    location / {
        index  index.php index.html index.htm;
        # Directory listing
        autoindex on;
    }
    # Password protect a directory
    location ^~ /secret_folder/ {
        auth_basic            "Restricted Area";
        # relative to this config file
        auth_basic_user_file  conf/htpasswd;
    }
}
```

Setup group and ownership of `www` folder

```sh
sudo -v
mkdir /home/www
usermod -a -G http ${USER}
chown -R http:http /home/www
chmod -R g+w /home/www
```

[Linux ACLs - Servers for Hackers](https://serversforhackers.com/video/linux-acls)

```sh
mkdir /home/www
getfacl /home/www
setfacl -R -m u:${USER}:rwx /var/www
```

## Proxy

[Load balancing (computing) - Wikiwand](https://www.wikiwand.com/en/Load_balancing_%28computing%29#/Server-side_Load_Balancers)
[Using nginx as HTTP load balancer](http://nginx.org/en/docs/http/load_balancing.html)
[NGINX Load Balancing - HTTP and TCP Load Balancer](https://www.nginx.com/resources/admin-guide/load-balancer/)
[Module ngx_http_proxy_module](http://nginx.org/en/docs/http/ngx_http_proxy_module.html)
[Module ngx_http_upstream_module](http://nginx.org/en/docs/http/ngx_http_upstream_module.html)

[Use Nginx as a Front-end Proxy and Software Load Balancer](https://www.linode.com/docs/uptime/loadbalancing/use-nginx-as-a-front-end-proxy-and-software-load-balancer)
[How To Configure Nginx as a Web Server and Reverse Proxy for Apache on One Ubuntu 14.04 Droplet | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-configure-nginx-as-a-web-server-and-reverse-proxy-for-apache-on-one-ubuntu-14-04-droplet)

### SSL Termination

[NGINX SSL Termination | NGINX](https://www.nginx.com/resources/admin-guide/nginx-ssl-termination/)
[How To Configure Nginx with SSL as a Reverse Proxy for Jenkins | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-configure-nginx-with-ssl-as-a-reverse-proxy-for-jenkins)
[How To Set Up Nginx Load Balancing with SSL Termination | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing-with-ssl-termination)

### Docker

[jwilder/nginx-proxy](https://hub.docker.com/r/jwilder/nginx-proxy/)
[Automated Nginx Reverse Proxy for Docker ·](http://jasonwilder.com/blog/2014/03/25/automated-nginx-reverse-proxy-for-docker/)

[jasonwyatt/docker-nginx-loadbalancer: Nginx Load Balancer for Docker. It reads links to containers which expose and generates a suitable Nginx config file at startup.](https://github.com/jasonwyatt/docker-nginx-loadbalancer)

[Using Nginx as a reverse proxy/load balancer with Weave and Docker - Weaveworks](https://www.weave.works/guides/using-nginx-as-a-reverse-proxyload-balancer-with-weave-and-docker/)

### CGI

[Understanding and Implementing FastCGI Proxying in Nginx | DigitalOcean](https://www.digitalocean.com/community/tutorials/understanding-and-implementing-fastcgi-proxying-in-nginx)

### load balancing

[Using nginx as HTTP load balancer](http://nginx.org/en/docs/http/load_balancing.html)
[NGINX Load Balancing - HTTP and TCP Load Balancer](https://www.nginx.com/resources/admin-guide/load-balancer/)
[How To Set Up Nginx Load Balancing | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing)
[Using NGINX on Heroku to Serve Single Page Apps and Avoid CORS — AlphaSights Engineering](https://m.alphasights.com/using-nginx-on-heroku-to-serve-single-page-apps-and-avoid-cors-5d013b171a45)

Add this to `hosts`:

```
127.0.0.1   mynodeapp.dev
```

> Uses [upstream module](http://nginx.org/en/docs/http/ngx_http_upstream_module.html) for abstraction and load balancing

```nginx
# node.conf

# using node app as an example backend
upstream node {
    server http://127.0.0.1:3000;
    server unix:/tmp/mynodeapp.socket;
}

server {
    listen 80;
    server_name mynodeapp.dev;
    location / {
            proxy_pass node;
            proxy_set_header Host $http_host;
    }
}
```

### Reverse proxy with `proxy_pass`

[Using NGINX to Serve .NET Core, Nodejs, or Static Contents - DZone Web Dev](https://dzone.com/articles/using-nginx-to-serve-net-core-nodejs-or-static-con)

Add this to `hosts`:

```
127.0.0.1   api.github.localhost
```

Add this to `/etc/nginx/sites-enabled/api.github`:

```nginx
server {
    listen 80;
    server_name api.github.localhost;

    location / {
        proxy_set_header Host api.github.com;
        proxy_pass https://api.github.com/;
    }

    access_log      /var/log/nginx/github_access.log combined;
    error_log       /var/log/nginx/github_error.log error;
}
```

### Reverse proxy with resolver

[Nginx resolver explained - The Matrix has you...](https://distinctplace.com/2017/04/19/nginx-resolver-explained/)

This allows the service to resolve dynamically to solve the issue when service is not available at Nginx startup (which causes start failure).

```nginx
http {
    resolver 172.16.0.23;
}

server {
    set $upstream_endpoint http://service-999999.eu-west-2.elb.amazonaws.com; # No trailing slash
    location /test/ {
      rewrite ^/test/(.*) /$1 break;
      proxy_pass $upstream_endpoint;
    }
}
```

We can generate `resolver` directive upon boot (or in ENTRYPOINT) with:

```sh
echo resolver $(awk 'BEGIN{ORS=" "} $1=="nameserver" {print $2}' /etc/resolv.conf) ";" > /etc/nginx/conf/resolvers.conf
```

```nginx
http {
    include resolvers.conf;
}
```

## Redirect

Redirect to https

```nginx
server {
    server_name _;
    rewrite ^ https://example.com$request_uri permanent;
}
```

[How To Redirect www to Non-www with Nginx on Ubuntu 14.04 | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-redirect-www-to-non-www-with-nginx-on-ubuntu-14-04)

## Status page

[Module ngx_http_api_module](http://nginx.org/en/docs/http/ngx_http_api_module.html)

## HTTP/2

> spun from SPDY from Google

[HTTP/2](https://http2.github.io/)

[HTTP 2.0 With Nginx - Servers for Hackers](https://serversforhackers.com/video/http-20-with-nginx)
[How To Set Up Nginx with HTTP/2 Support on Ubuntu 16.04 | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-with-http-2-support-on-ubuntu-16-04)

## HTTP/3

> spun from QUIC from Google

[HTTP/3 - HTTP over QUIC is the next generation by Daniel Stenberg - YouTube](https://www.youtube.com/watch?v=idViw4anA6E)
[Understand HTTP3 in 5 minutes - Je suis un dev](https://www.jesuisundev.com/en/understand-http3-in-5-minutes/)

## CORS

[enable cross-origin resource sharing](http://enable-cors.org/index.html)
[Example Nginx configuration for adding cross-origin resource sharing (CORS) support to reverse proxied APIs](https://gist.github.com/Stanback/7145487)
[Wide-open CORS config for nginx](https://gist.github.com/michiel/1064640)
[How CORS (Cross-Origin Resource Sharing) Works? - The Startup - Medium](https://medium.com/swlh/how-cors-cross-origin-resource-sharing-works-79f959a84f0e)
[Cross Origin Resource Sharing (Explained by Example) - YouTube](https://www.youtube.com/watch?v=Ka8vG5miErk)

## Node/Nginx

> these settings are not tested

[How To Set Up a Node.js Application for Production on Ubuntu 14.04 | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-node-js-application-for-production-on-ubuntu-14-04)
[How To Deploy Node.js Applications Using Systemd and Nginx | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-deploy-node-js-applications-using-systemd-and-nginx)
[How To Host Multiple Node.js Applications On a Single VPS with nginx, forever, and crontab | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-host-multiple-node-js-applications-on-a-single-vps-with-nginx-forever-and-crontab)
[rubenv/node-systemd: Support for running node.js as a socket-activated service under systemd](https://github.com/rubenv/node-systemd)
[Deploying Node.js with systemd · Ruben Vermeersch (rubenv)](https://rocketeer.be/articles/deploying-node-js-with-systemd/)
[How to run a Node.js server with Nginx - LogRocket Blog](https://blog.logrocket.com/how-to-run-a-node-js-server-with-nginx/)

```nginx
# node.conf

server {
    listen 80;
    server_name localhost
    location / {
        root   /home/www;
    }
    location /api/ {
        # forward API endpoint to internal API server
        proxy_pass http://192.168.1.10:3000;
        proxy_set_header Host $http_host;
    }
}
```

## Nginx status page

```nginx
location /nginx_status {
    # Turn on nginx stats
    stub_status on;
    # I do not need logs for stats
    access_log   off;
    # Security: Only allow access from 192.168.1.100 IP #
    allow 192.168.1.100;
    # Send rest of the world to /dev/null #
    deny all;
}
```
